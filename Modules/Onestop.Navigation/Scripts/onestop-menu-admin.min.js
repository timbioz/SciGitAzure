function ToggleCallback(n,t){t=t?t:$(this),t.hasClass("toggle-expand")?t.parent("li").expand(n):t.hasClass("toggle-collapse")&&t.parent("li").collapse(n)}function EnsureItems(n,t,i,r){var u=n.data("id"),f=n.children(".itemlist"),e=n.children(".toggle");u||u==0?LoadChildren(u,$("#itemsheader").data("loadchildrenurl"),function(n,u,o){if(n&&(!o||i))if(u)e.hide(),childToggle.removeClass("enabled");else{var s=f.children("li");r&&r>0&&(r--,s.each(function(){var n=$(this);EnsureItems(n,null,i,r)})),s.length&&s.each(function(){var n=$(this).children(".toggle");n.off("click"),n.click(function(){ToggleCallback(!1,n)}),CountChildren($(this).data("id"),function(){n.show(),n.addClass("enabled"),t&&t()},function(){n.hide(),n.removeClass("enabled"),t&&t()})})}else t&&t()},i,n):f.children("li").each(function(){EnsureItems($(this),t,i,r)})}function LoadChildren(n,t,i,r,u){var e={itemId:n,differentiator:"published"},f=u.children(".itemlist"),o=f.closest(".itemlist").data("loaded")===!0;!o||r?Async(t,e,"GET",function(t){f.empty().html(t),n==0||IsExpanded(u)?f.show():f.hide(),f.closest(".itemlist").data("loaded",!0),i&&i(!0,!/\S/.test(t),!1),RefreshSubtree(f,!/\S/.test(t))},function(){f.empty(),f.closest(".itemlist").data("loaded",!1),i&&i(!1,!0,!1)}):i&&i(!0,!1,!0)}function RefreshSubtree(n,t){var f=n?$(n):$("#current-items > .itemlist"),i=n?$(n):$(document),e,r,u;i.find(".dropdown-menu input, .dropdown-menu label, .dropdown-menu").click(function(n){n.stopPropagation()}),i.find("[rel=tooltip]").tooltip(),t||$("#global-trigger-all:hidden").fadeIn(600),e=f.find(".changed, .removed, .new"),e.length&&($("#global-trigger-changed:hidden").fadeIn(400),$("#global-clear-drafts:hidden").fadeIn(400)),i.find("[data-forclass]").each(function(){var n=$(this),t=n.closest("div"),i=n.data("forclass");t&&/\S/.test(i)&&t.hasClass(i)&&n.show()}),i.find("[data-notforclass]").each(function(){var n=$(this),t=n.closest("div"),i=n.data("notforclass");t&&/\S/.test(i)&&!t.hasClass(i)&&n.show()}),r=i.find("a[itemprop~=UnsafeUrl]"),u=i.find("a[itemprop~=AjaxUrl]"),r.setConfirmModals(),u.setConfirmModals(),RefreshUnsafeUrls(r),AjaxifyUrls(u)}function Update(n,t){if(EnsureDraftMode()){var i=[],r=0;$(t.item).removeClass("no-nest"),$(t.item).parent().parent("li").each(function(){r=$(this).data("id")}),t.item.parent().children(".item").each(function(){i.push($(this).data("id"))}),SendTreeUpdateRequest(t.item,r,i)}else $(t.sender?t.sender:n.target).sortable("cancel")}function SendTreeUpdateRequest(n,t,i){var r=$("#itemsheader").data("moveurl"),f=$("#itemsheader").data("draftviewurl"),u={__RequestVerificationToken:$("[name=__RequestVerificationToken]").attr("value"),newChildren:i,parentId:t};Async(r,u,"POST",function(){$(n).data("parentid",t);var i=t>0?$("#item-"+t):$("#current-items");EnsureItems(i,null,!0,0)})}function MakeDraft(n,t){var i,r,u;EnsureDraftMode()&&(i=$(t.item).data("id"),$(t.item).addClass("no-nest"),r=$("#itemsheader").data("drafturl"),u={__RequestVerificationToken:$("[name=__RequestVerificationToken]").attr("value"),itemId:i},Async(r,u,"POST"))}function CountChildren(n,t,i){var r=$("#itemsheader").data("countchildrenurl"),u={itemId:n};Async(r,u,"GET",function(n){var r=n.count;r>0&&t?t():r<=0&&i&&i()},null,null,!0)}function DisplayPositionForm(n){n.hasClass("enter-position")?(n.removeClass("enter-position"),n.addClass("form-position"),n.html('<input type="textbox" class="position-text"><\/input><button type="submit" class="submit" onclick="SetPosition($(this));">Save<\/button>&nbsp;<button type="submit" class="submit" onclick="CancelSetPosition($(this));">Cancel<\/button>'),n.children(".submit-save").click(function(){SetPosition(n)}),n.children(".submit-cancel").click(function(){CancelSetPosition(n)})):(n.addClass("enter-position"),n.removeClass("form-position"))}function SetPosition(n){if(EnsureDraftMode()){var t=$(n).siblings(".position-text").val(),u=$("#itemsheader").data("setpositionurl"),i=$(n).parent().parent().parent().parent(),f=i.attr("id"),e={__RequestVerificationToken:$("[name=__RequestVerificationToken]").attr("value"),itemId:i.data("id"),position:t},r=$(n).parent();r.html("Saving..."),r.unbind("click"),Async(u,e,"POST",function(){i.fadeOut(500).remove();var r=t.lastIndexOf("."),u=r>0?t.substr(0,r):"0",n=$('[data-position="'+u+'"]');n=n.length?n:$('[data-position="0"]'),EnsureItems(n,function(){n.expand(),n.parents("li").expand(),ScrollTo("#"+f)},!0,0)},function(){PositionSetError(r)})}}function EnsureDraftMode(){var n=$("#itemsheader").data("mode"),t;return n!="Draft"?(t=$("#itemsheader").data("draftviewurl"),confirm("Not allowed in 'Current' view mode. You need to be in 'Draft' mode to modify the menu.\n\nClick OK to go to Draft mode, or hit Cancel to stay on the current page.")&&window.location.replace(t),!1):!0}function PositionSetSuccess(n,t){n.html("Position set to <b>"+t+"<\/b>.")}function PositionSetError(n){n.html("<b>Error!<\/b><br/>Please try again."),n.unbind("click").click(function(){DisplayPositionForm(n)})}function CancelSetPosition(n){n.parent().html("Click to edit"),n.parent().unbind("click").click(function(){DisplayPositionForm(n.parent())})}function ScrollTo(n){$("html, body").animate({scrollTop:$(n).offset().top-200},500)}function IsExpanded(n){return n.children(".toggle").hasClass("toggle-collapse")}function Async(n,t,i,r,u,f,e){$.ajax({type:i,data:t,url:n,traditional:!0,tryCount:0,retryLimit:5,beforeSend:function(){e||runningAjaxCalls++},complete:function(){f&&f(),e||runningAjaxCalls--},success:r,error:function(t,i,r){if(this.tryCount++,t.status!=0&&this.tryCount<=this.retryLimit){console.log("Async call to url '"+n+"' failed. Retrying ("+this.tryCount+" of "+this.retryLimit+")"),$.ajax(this);return}u&&u(t,i,r)}})}function RefreshUnsafeUrls(n){var t=$("input[name=__RequestVerificationToken]").first();t&&n.filter("a[itemprop~=UnsafeUrl]").each(function(){var u=$(this),i=u.attr("href").split("?"),n=$('<form action="'+i[0]+'" method="POST" />'),f,r,e;if(n.append(t.clone()),i.length>1)for(f=i[1].split("&"),r=0;r<f.length;r++)e=f[r].split("="),n.append($('<input type="hidden" name="'+decodeURIComponent(e[0])+'" value="'+decodeURIComponent(e[1])+'" />'));n.css({position:"absolute",left:"-9999em"}),$("body").append(n),u.click(function(){return n.submit(),!1})})}function AjaxifyUrls(n){var t=$("input[name=__RequestVerificationToken]").first();t&&n.filter("a[itemprop~=AjaxUrl]").each(function(){var u={__RequestVerificationToken:t.val()},n=$(this),i=n.attr("href").split("?"),f,r,e;if(i.length>1)for(f=i[1].split("&"),r=0;r<f.length;r++)e=f[r].split("="),u[decodeURIComponent(e[0])]=decodeURIComponent(e[1]);n.click(function(t){return EnsureDraftMode()&&(t.preventDefault(),Async(i[0],u,"POST",function(){var t=n.closest("li").data("parentid"),i;t>=0&&(i=t>0?$("#item-"+t):$("#current-items"),EnsureItems(i,function(){ScrollTo(i)},!0,0))})),t.stopImmediatePropagation(),!1})})}var runningAjaxCalls=0,allCompleteCallback=null;$(document).ready(function(){var n=!1,u,f,i,t,r;$("#current-items > ol.sortable.enabled").nestedSortable({items:"li",handle:".wrapper > .header",dropOnEmpty:!0,toleranceElement:"> div.wrapper",tolerance:"pointer",helper:"clone",opacity:.6,placeholder:"placeholder",revert:200,tabSize:40,forcePlaceholderSize:!0,connectWith:".sortable",start:function(){},receive:function(t,i){Update(t,i,0),n=!1},remove:function(){n=!0},stop:function(t,i){i.sender!=undefined||n||Update(t,i),n=!1},disableNesting:"no-nest"}).disableSelection(),$("#draft-items > ol.sortable.enabled").nestedSortable({items:"li",handle:".wrapper > .header",receive:MakeDraft,dropOnEmpty:!0,toleranceElement:"> div.wrapper",tolerance:"pointer",helper:"clone",opacity:.6,placeholder:"placeholder",revert:200,tabSize:40,forcePlaceholderSize:!0,connectWith:".sortable",disableNesting:"no-nest"}).disableSelection(),u=function(){var n=$(".changed, .removed, .new").parents("li");$(this).hasClass("collapse-changed")?(n.collapse(),$(this).addClass("expand-changed"),$(this).removeClass("collapse-changed"),$(this).html("Expand all")):(n.expand(),$(this).addClass("collapse-changed"),$(this).removeClass("expand-changed"),$(this).html("Collapse all"))},f=function(){$(this).hasClass("collapse-all")?($("#current-items .itemlist > li").collapse(!0),$(this).addClass("expand-all"),$(this).removeClass("collapse-all"),$(this).html("Expand all")):($("#current-items .itemlist > li").expand(!0),$(this).addClass("collapse-all"),$(this).removeClass("expand-all"),$(this).html("Collapse all"))},$("#expand-all").click(f),$("#expand-changed").click(u),$(".enabled .item .enter-position").click(function(){DisplayPositionForm($(this))}),i=$("#current-items"),i.fadeIn(3e3),allCompleteCallback=function(){allCompleteCallback=null},EnsureItems(i,function(){RefreshSubtree()},!1,0),t=$("#loading"),r=$("#loading .bar"),$(document).ajaxSend(function(){runningAjaxCalls>0&&(t.show(),r.html("Work in progress: "+runningAjaxCalls+" operations left."))}),$(document).ajaxComplete(function(){runningAjaxCalls==0?(t.hide(),allCompleteCallback&&allCompleteCallback()):(t.show(),r.html("Work in progress: "+runningAjaxCalls+" operations left."))})}),$(function(){$("[data-toggle]").each(function(){var n=$("#"+$(this).attr("data-toggle")),t=$(this),i=$(this).attr("data-defaultstate")=="hidden";i?$(this).hide():$(this).hide().show(),n.css("cursor","pointer"),n.click(function(){t.slideToggle(100)})})}),jQuery.fn.expand=function(n){this.each(function(){var i=$(this).children(".toggle.enabled"),u,r;i.length&&(u=i.hasClass("toggle-expand"),r=$(this).children(".itemlist"),EnsureItems($(this),function(){n&&r.children("li").expand(n),u&&(r.slideDown(100),r.fadeIn(100),i.removeClass("toggle-expand"),i.addClass("toggle-collapse"))},!1,0))})},jQuery.fn.collapse=function(n){this.each(function(){var i=$(this).children(".toggle.enabled"),u=i.hasClass("toggle-collapse"),r=$(this).children(".itemlist");n&&r.children("li").collapse(n),u&&(r.slideUp(100),r.fadeOut(100),i.removeClass("toggle-collapse"),i.addClass("toggle-expand"))})}